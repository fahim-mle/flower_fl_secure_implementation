# jupyterhub-config/jupyterhub_config.py
print("!!! JUPYTERHUB CONFIG LOADED SUCCESSFULLY !!!")

# === Basic JupyterHub Configuration ===
# Tell JupyterHub to use the persistent cookie secret file we just created.
# This file is mounted into the container via docker-compose.yml.
c.JupyterHub.cookie_secret_file = "/srv/jupyterhub/cookie_secret"

# This is CRITICAL. It tells JupyterHub its public-facing URL,
# which it uses to generate the correct OAuth callback URL.
c.JupyterHub.bind_url = "http://localhost:8000/"

# This helps manage the CSRF flow when using an external login service.
c.JupyterHub.login_service = "Keycloak"

# === OAuthenticator Configuration for Keycloak ===
c.JupyterHub.authenticator_class = "oauthenticator.GenericOAuthenticator"

# --- Keycloak OAuth URLs ---
# IMPORTANT: JupyterHub runs inside Docker, so it must use the Docker
# network name 'keycloak' and the internal port '8080' to communicate
# with the Keycloak container.
c.GenericOAuthenticator.authorize_url = (
    "http://keycloak:8080/realms/fl-realm/protocol/openid-connect/auth"
)
c.GenericOAuthenticator.token_url = (
    "http://keycloak:8080/realms/fl-realm/protocol/openid-connect/token"
)
c.GenericOAuthenticator.userdata_url = (
    "http://keycloak:8080/realms/fl-realm/protocol/openid-connect/userinfo"
)

# The callback URL is what the BROWSER uses to talk to JupyterHub,
# so it must be 'localhost:8000'.
c.GenericOAuthenticator.oauth_callback_url = "http://localhost:8000/hub/oauth_callback"

# --- Keycloak Client Configuration ---
c.GenericOAuthenticator.client_id = "jupyterhub-client"
c.GenericOAuthenticator.client_secret = ""  # Empty for a public client

# --- User Data Mapping ---
# Use the 'preferred_username' claim from Keycloak as the JupyterHub username.
c.GenericOAuthenticator.username_key = "preferred_username"

# Enable debug logging for more verbose output if needed.
c.Application.log_level = "INFO"

# === DockerSpawner Configuration ===
c.JupyterHub.spawner_class = "dockerspawner.DockerSpawner"
c.DockerSpawner.image = "jupyter/datascience-notebook:latest"
c.DockerSpawner.remove = True
c.DockerSpawner.network_name = "flower_fl_secure_implementation_fl-internal-network"  # Use the generated network name

# === Admin Users ===
c.Authenticator.admin_users = {"admin"}
